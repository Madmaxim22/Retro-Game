/*! For license information please see main.63197712d90e0f78bc31.js.LICENSE.txt */
(()=>{"use strict";function t(t,e){var r=Math.floor(t/e),n=t%e,o=0===r,a=r===e-1,i=0===n,c=n===e-1;return o&&i?"top-left":o&&c?"top-right":a&&i?"bottom-left":a&&c?"bottom-right":o?"top":a?"bottom":i?"left":c?"right":"center"}function e(t){return t<15?"critical":t<50?"normal":"high"}function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}function n(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=o(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,c=!0,u=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return c=t.done,t},e:function(t){u=!0,i=t},f:function(){try{c||null==r.return||r.return()}finally{if(u)throw i}}}}function o(t,e){if(t){if("string"==typeof t)return a(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?a(t,e):void 0}}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function i(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,c(n.key),n)}}function c(t){var e=function(t){if("object"!=r(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==r(e)?e:e+""}var u=function(){return r=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]},c=[{key:"bindToDOM",value:function(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}},{key:"drawUi",value:function(e){var r=this;this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",function(t){return r.onNewGameClick(t)}),this.saveGameEl.addEventListener("click",function(t){return r.onSaveGameClick(t)}),this.loadGameEl.addEventListener("click",function(t){return r.onLoadGameClick(t)}),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(var n=0;n<Math.pow(this.boardSize,2);n+=1){var o=document.createElement("div");o.classList.add("cell","map-tile","map-tile-".concat(t(n,this.boardSize))),o.addEventListener("mouseenter",function(t){return r.onCellEnter(t)}),o.addEventListener("mouseleave",function(t){return r.onCellLeave(t)}),o.addEventListener("click",function(t){return r.onCellClick(t)}),this.boardEl.appendChild(o)}this.cells=Array.from(this.boardEl.children)}},{key:"redrawPositions",value:function(t){var r,o=n(this.cells);try{for(o.s();!(r=o.n()).done;)r.value.innerHTML=""}catch(t){o.e(t)}finally{o.f()}var a,i=n(t);try{for(i.s();!(a=i.n()).done;){var c=a.value,u=this.boardEl.children[c.position],l=document.createElement("div");l.classList.add("character",c.character.type);var s=document.createElement("div");s.classList.add("health-level");var f=document.createElement("div");f.classList.add("health-level-indicator","health-level-indicator-".concat(e(c.character.health))),f.style.width="".concat(c.character.health,"%"),s.appendChild(f),l.appendChild(s),u.appendChild(l)}}catch(t){i.e(t)}finally{i.f()}}},{key:"addCellEnterListener",value:function(t){this.cellEnterListeners.push(t)}},{key:"addCellLeaveListener",value:function(t){this.cellLeaveListeners.push(t)}},{key:"addCellClickListener",value:function(t){this.cellClickListeners.push(t)}},{key:"addNewGameListener",value:function(t){this.newGameListeners.push(t)}},{key:"addSaveGameListener",value:function(t){this.saveGameListeners.push(t)}},{key:"addLoadGameListener",value:function(t){this.loadGameListeners.push(t)}},{key:"onCellEnter",value:function(t){t.preventDefault();var e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach(function(t){return t.call(null,e)})}},{key:"onCellLeave",value:function(t){t.preventDefault();var e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach(function(t){return t.call(null,e)})}},{key:"onCellClick",value:function(t){var e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach(function(t){return t.call(null,e)})}},{key:"onNewGameClick",value:function(t){t.preventDefault(),this.newGameListeners.forEach(function(t){return t.call(null)})}},{key:"onSaveGameClick",value:function(t){t.preventDefault(),this.saveGameListeners.forEach(function(t){return t.call(null)})}},{key:"onLoadGameClick",value:function(t){t.preventDefault(),this.loadGameListeners.forEach(function(t){return t.call(null)})}},{key:"selectCell",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected","selected-".concat(e))}},{key:"deselectCell",value:function(t){var e,r=this.cells[t];(e=r.classList).remove.apply(e,function(t){return function(t){if(Array.isArray(t))return a(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||o(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(Array.from(r.classList).filter(function(t){return t.startsWith("selected")})))}},{key:"showCellTooltip",value:function(t,e){this.cells[e].title=t}},{key:"hideCellTooltip",value:function(t){this.cells[t].title=""}},{key:"showDamage",value:function(t,e){var r=this;return new Promise(function(n){var o=r.cells[t],a=document.createElement("span");a.textContent=e,a.classList.add("damage"),o.appendChild(a),a.addEventListener("animationend",function(){o.removeChild(a),n()})})}},{key:"setCursor",value:function(t){this.boardEl.style.cursor=t}},{key:"checkBinding",value:function(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}},{key:"highlightRange",value:function(t,e){this.clearHighlights();for(var r=Math.floor(t/this.boardSize),n=t%this.boardSize,o=Math.max(0,r-e),a=Math.min(this.boardSize-1,r+e),i=Math.max(0,n-e),c=Math.min(this.boardSize-1,n+e),u=o;u<=a;u++)for(var l=i;l<=c;l++){var s=u*this.boardSize+l;this.cells[s].classList.add("highlight-border")}}},{key:"clearHighlights",value:function(){this.cells.forEach(function(t){t.classList.remove("highlight-border")})}}],u=[{key:"showError",value:function(t){alert(t)}},{key:"showMessage",value:function(t){alert(t)}}],c&&i(r.prototype,c),u&&i(r,u),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,c,u}();const l={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"},s="pointer",f="crosshair",h="not-allowed";function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function p(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,v(n.key),n)}}function v(t){var e=function(t){if("object"!=y(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=y(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==y(e)?e:e+""}function d(t,e,r){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.set(t,r)}function m(t,e){return t.get(g(t,e))}function b(t,e,r){return t.set(g(t,e),r),r}function g(t,e,r){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:r;throw new TypeError("Private element is not present on this object")}var w=["bowman","swordsman","magician","daemon","undead","vampire"],C=new WeakMap,S=new WeakMap,k=new WeakMap,P=new WeakMap,O=new WeakMap,T=function(){return t=function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),d(this,C,void 0),d(this,S,void 0),d(this,k,void 0),d(this,P,void 0),d(this,O,void 0),"Character"==(this instanceof t?this.constructor:void 0).name)throw new Error("The creation of the Character class is prohibited");this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=r},(e=[{key:"type",get:function(){return m(C,this)},set:function(t){if(!w.includes(t))throw new Error("Invalid type: ".concat(t,". Must be one of: ").concat(w.join(", ")));b(C,this,t)}},{key:"health",get:function(){return m(S,this)},set:function(t){if("number"!=typeof t)throw new Error("Invalid type: ".concat(t,", must be number"));b(S,this,t)}},{key:"level",get:function(){return m(k,this)},set:function(t){if(!("number"==typeof t&&t>0&&t<=4))throw new Error("Invalid type: ".concat(t,", must be number"));b(k,this,t)}},{key:"attack",get:function(){return m(P,this)},set:function(t){if("number"!=typeof t)throw new Error("Invalid type: ".concat(t,", must be number"));b(P,this,t)}},{key:"defence",get:function(){return m(O,this)},set:function(t){if("number"!=typeof t)throw new Error("Invalid type: ".concat(t,", must be number"));b(O,this,t)}}])&&p(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function j(t){return j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},j(t)}function E(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(E=function(){return!!t})()}function M(t){return M=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},M(t)}function x(t,e){return x=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},x(t,e)}var L=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=M(e),function(t,e){if(e&&("object"==j(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,E()?Reflect.construct(e,r||[],M(t).constructor):e.apply(t,r))}(this,e,[t,"bowman"])).attack=25,r.defence=25,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&x(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function I(t){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},I(t)}function _(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(_=function(){return!!t})()}function A(t){return A=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},A(t)}function G(t,e){return G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},G(t,e)}var R=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=A(e),function(t,e){if(e&&("object"==I(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,_()?Reflect.construct(e,r||[],A(t).constructor):e.apply(t,r))}(this,e,[t,"vampire"])).attack=25,r.defence=25,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&G(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function z(t){return z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},z(t)}function B(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(B=function(){return!!t})()}function D(t){return D=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},D(t)}function N(t,e){return N=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},N(t,e)}var H=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=D(e),function(t,e){if(e&&("object"==z(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,B()?Reflect.construct(e,r||[],D(t).constructor):e.apply(t,r))}(this,e,[t,"undead"])).attack=40,r.defence=10,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&N(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function U(t){return U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},U(t)}function W(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(W=function(){return!!t})()}function F(t){return F=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},F(t)}function q(t,e){return q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},q(t,e)}var $=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=F(e),function(t,e){if(e&&("object"==U(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,W()?Reflect.construct(e,r||[],F(t).constructor):e.apply(t,r))}(this,e,[t,"magician"])).attack=10,r.defence=40,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&q(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function J(t){return J="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},J(t)}function V(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(V=function(){return!!t})()}function K(t){return K=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},K(t)}function Q(t,e){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Q(t,e)}var X=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=K(e),function(t,e){if(e&&("object"==J(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,V()?Reflect.construct(e,r||[],K(t).constructor):e.apply(t,r))}(this,e,[t,"daemon"])).attack=10,r.defence=10,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Q(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function Y(t){return Y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Y(t)}function Z(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(Z=function(){return!!t})()}function tt(t){return tt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},tt(t)}function et(t,e){return et=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},et(t,e)}var rt=function(t){function e(t){var r;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),(r=function(t,e,r){return e=tt(e),function(t,e){if(e&&("object"==Y(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,Z()?Reflect.construct(e,r||[],tt(t).constructor):e.apply(t,r))}(this,e,[t,"swordsman"])).attack=40,r.defence=10,r}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&et(t,e)}(e,t),r=e,Object.defineProperty(r,"prototype",{writable:!1}),r;var r}(T);function nt(t){return nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},nt(t)}function ot(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,it(n.key),n)}}function at(t,e,r){return e&&ot(t.prototype,e),r&&ot(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function it(t){var e=function(t){if("object"!=nt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=nt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==nt(e)?e:e+""}var ct=at(function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.characters=e});function ut(){var t,e,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,l=Object.create(u.prototype);return lt(l,"_invoke",function(r,n,o){var a,c,u,l=0,s=o||[],f=!1,h={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,r){return a=e,c=0,u=t,h.n=r,i}};function y(r,n){for(c=r,u=n,e=0;!f&&l&&!o&&e<s.length;e++){var o,a=s[e],y=h.p,p=a[2];r>3?(o=p===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=t):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,h.v=n,h.n=a[1]):y<p&&(o=r<3||a[0]>n||n>p)&&(a[4]=r,a[5]=n,h.n=p,c=0))}if(o||r>1)return i;throw f=!0,n}return function(o,s,p){if(l>1)throw TypeError("Generator is already running");for(f&&1===s&&y(s,p),c=s,u=p;(e=c<2?t:u)||!f;){a||(c?c<3?(c>1&&(h.n=-1),y(c,u)):h.n=u:h.v=u);try{if(l=2,a){if(c||(o="next"),e=a[o]){if(!(e=e.call(a,u)))throw TypeError("iterator result is not an object");if(!e.done)return e;u=e.value,c<2&&(c=0)}else 1===c&&(e=a.return)&&e.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=t}else if((e=(f=h.n<0)?u:r.call(n,h))!==i)break}catch(e){a=t,c=1,u=e}finally{l=1}}return{value:e,done:f}}}(r,o,a),!0),l}var i={};function c(){}function u(){}function l(){}e=Object.getPrototypeOf;var s=[][n]?e(e([][n]())):(lt(e={},n,function(){return this}),e),f=l.prototype=c.prototype=Object.create(s);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,lt(t,o,"GeneratorFunction")),t.prototype=Object.create(f),t}return u.prototype=l,lt(f,"constructor",l),lt(l,"constructor",u),u.displayName="GeneratorFunction",lt(l,o,"GeneratorFunction"),lt(f),lt(f,o,"Generator"),lt(f,n,function(){return this}),lt(f,"toString",function(){return"[object Generator]"}),(ut=function(){return{w:a,m:h}})()}function lt(t,e,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}lt=function(t,e,r,n){function a(e,r){lt(t,e,function(t){return this._invoke(e,r,t)})}e?o?o(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n}):t[e]=r:(a("next",0),a("throw",1),a("return",2))},lt(t,e,r,n)}var st=ut().m(ft);function ft(t,e){var r,n;return ut().w(function(o){for(;;)switch(o.n){case 0:return r=t[Math.floor(Math.random()*t.length)],n=Math.floor(Math.random()*e)+1,o.n=1,new r(n);case 1:o.n=0;break;case 2:return o.a(2)}},st)}function ht(t,e,r){for(var n=ft(t,e),o=[],a=0;a<r;a++)o.push(n.next().value);return new ct(o)}function yt(t){return yt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},yt(t)}function pt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,vt(n.key),n)}}function vt(t){var e=function(t){if("object"!=yt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=yt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==yt(e)?e:e+""}var dt=function(){function t(e){var r=e.currentTheme,n=e.currentTurn,o=e.characterPositions,a=e.selectedCharacterIndex,i=e.activeSelectCell,c=e.gameOver,u=e.maxScore;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.currentTheme=r,this.currentTurn=n,this.characterPositions=o,this.selectedCharacterIndex=a,this.activeSelectCell=i,this.gameOver=c,this.maxScore=u||0}return e=t,r=[{key:"from",value:function(e){return e?new t(e):null}}],null&&pt(e.prototype,null),r&&pt(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r}();function mt(t){return mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},mt(t)}function bt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,gt(n.key),n)}}function gt(t){var e=function(t){if("object"!=mt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=mt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==mt(e)?e:e+""}var wt=function(){return t=function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.boardSize=e,this.characterManager=r},e=[{key:"calculateDistance",value:function(t,e){var r=Math.floor(t/this.boardSize),n=t%this.boardSize,o=Math.floor(e/this.boardSize),a=e%this.boardSize;return Math.max(Math.abs(r-o),Math.abs(n-a))}},{key:"getBorderColumnsIndices",value:function(){for(var t=[],e="first"===(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"first"),r=0;r<this.boardSize;r++){var n=r*this.boardSize;t.push(n+(e?0:this.boardSize-2),n+(e?1:this.boardSize-1))}return t}},{key:"calculateNextPosition",value:function(t,e,r){var n=Math.floor(t/this.boardSize),o=t%this.boardSize,a=Math.floor(e/this.boardSize)-n,i=e%this.boardSize-o,c=Math.max(Math.abs(a),Math.abs(i));if(0===c)return t;for(var u=Math.min(r,c);u>0;u--){var l=Math.round(a/c*u),s=Math.round(i/c*u),f=Math.max(0,Math.min(this.boardSize-1,n+l)),h=Math.max(0,Math.min(this.boardSize-1,o+s)),y=f*this.boardSize+h;if(y!==t&&!this.characterManager.isPositionOccupied(y))return y}return t}}],e&&bt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function Ct(t){return Ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ct(t)}function St(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Pt(n.key),n)}}function kt(t,e,r){return e&&St(t.prototype,e),r&&St(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function Pt(t){var e=function(t){if("object"!=Ct(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=Ct(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Ct(e)?e:e+""}var Ot=kt(function t(e,r){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),!(e instanceof T))throw new Error("character must be instance of Character or its children");if("number"!=typeof r)throw new Error("position must be a number");this.character=e,this.position=r});function Tt(t){return Tt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Tt(t)}function jt(t,e){if(t){if("string"==typeof t)return Et(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Et(t,e):void 0}}function Et(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function Mt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,xt(n.key),n)}}function xt(t){var e=function(t){if("object"!=Tt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=Tt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Tt(e)?e:e+""}var Lt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.charactersMap=new Map,this.positionedCharacters=[]},e=[{key:"addCharacter",value:function(t,e){this.charactersMap.set(e,t),this.positionedCharacters.push(new Ot(t,e))}},{key:"removeCharacter",value:function(t){this.charactersMap.delete(t),this.positionedCharacters=this.positionedCharacters.filter(function(e){return e.position!==t})}},{key:"moveCharacter",value:function(t,e){var r=this.positionedCharacters.find(function(e){return e.position===t});return!!r&&(this.charactersMap.delete(t),this.charactersMap.set(e,r.character),r.position=e,!0)}},{key:"getCharacterAt",value:function(t){return this.charactersMap.get(t)}},{key:"isPositionOccupied",value:function(t){return this.charactersMap.has(t)}},{key:"getCharactersByTeam",value:function(t,e){return{player:this.positionedCharacters.filter(function(e){return t.some(function(t){return e.character instanceof t})}),computer:this.positionedCharacters.filter(function(t){return e.some(function(e){return t.character instanceof e})})}}},{key:"assignTeamToPositions",value:function(t,e){var r,n=function(t){return function(t){if(Array.isArray(t))return Et(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||jt(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(e),o=function(t){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!e){if(Array.isArray(t)||(e=jt(t))){e&&(t=e);var r=0,n=function(){};return{s:n,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,i=!1;return{s:function(){e=e.call(t)},n:function(){var t=e.next();return a=t.done,t},e:function(t){i=!0,o=t},f:function(){try{a||null==e.return||e.return()}finally{if(i)throw o}}}}(t);try{for(o.s();!(r=o.n()).done;){var a=r.value;if(0===n.length)break;var i=Math.floor(Math.random()*n.length),c=n.splice(i,1)[0];this.addCharacter(a,c)}}catch(t){o.e(t)}finally{o.f()}}}],e&&Mt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function It(t){return It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},It(t)}function _t(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return At(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?At(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,c=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return i=t.done,t},e:function(t){c=!0,a=t},f:function(){try{i||null==r.return||r.return()}finally{if(c)throw a}}}}function At(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function Gt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Rt(n.key),n)}}function Rt(t){var e=function(t){if("object"!=It(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=It(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==It(e)?e:e+""}var zt=function(){return t=function t(e,r,n,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.characterManager=e,this.positionCalculator=r,this.playerTypes=n,this.opponentTypes=o},(e=[{key:"findBestAction",value:function(t){var e,r=_t(t);try{for(r.s();!(e=r.n()).done;){var n=e.value,o=this.findAttackTarget(n.position,n.character);if(o)return{fromIndex:n.position,toIndex:o.position,type:Jt}}}catch(t){r.e(t)}finally{r.f()}var a,i=_t(t);try{for(i.s();!(a=i.n()).done;){var c=a.value,u=this.findMoveAction(c.position,c.character);if(u)return u}}catch(t){i.e(t)}finally{i.f()}return null}},{key:"findAttackTarget",value:function(t,e){var r=this,n=this.getAttackRange(e),o=this.characterManager.getCharactersByTeam(this.playerTypes,this.opponentTypes).player.filter(function(e){return r.positionCalculator.calculateDistance(t,e.position)<=n});return 0===o.length?null:o.reduce(function(t,e){return t.character.health<e.character.health?t:e})}},{key:"findMoveAction",value:function(t,e){var r=this,n=this.characterManager.getCharactersByTeam(this.playerTypes,this.opponentTypes).player;if(0===n.length)return null;var o=n.reduce(function(e,n){var o=r.positionCalculator.calculateDistance(t,e.position);return r.positionCalculator.calculateDistance(t,n.position)<o?n:e}),a=this.positionCalculator.calculateNextPosition(t,o.position,this.getMoveRange(e));return a!==t&&!this.characterManager.isPositionOccupied(a)&&this.positionCalculator.calculateDistance(t,a)<=this.getMoveRange(e)?{fromIndex:t,toIndex:a,type:Vt}:null}},{key:"getMoveRange",value:function(t){var e,r;return null!==(e=null===(r=Kt[t.constructor.name])||void 0===r?void 0:r.move)&&void 0!==e?e:1}},{key:"getAttackRange",value:function(t){var e,r;return null!==(e=null===(r=Kt[t.constructor.name])||void 0===r?void 0:r.attack)&&void 0!==e?e:1}}])&&Gt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function Bt(t){return Bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Bt(t)}function Dt(){var t,e,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function a(r,n,o,a){var u=n&&n.prototype instanceof c?n:c,l=Object.create(u.prototype);return Nt(l,"_invoke",function(r,n,o){var a,c,u,l=0,s=o||[],f=!1,h={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,r){return a=e,c=0,u=t,h.n=r,i}};function y(r,n){for(c=r,u=n,e=0;!f&&l&&!o&&e<s.length;e++){var o,a=s[e],y=h.p,p=a[2];r>3?(o=p===n)&&(u=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=t):a[0]<=y&&((o=r<2&&y<a[1])?(c=0,h.v=n,h.n=a[1]):y<p&&(o=r<3||a[0]>n||n>p)&&(a[4]=r,a[5]=n,h.n=p,c=0))}if(o||r>1)return i;throw f=!0,n}return function(o,s,p){if(l>1)throw TypeError("Generator is already running");for(f&&1===s&&y(s,p),c=s,u=p;(e=c<2?t:u)||!f;){a||(c?c<3?(c>1&&(h.n=-1),y(c,u)):h.n=u:h.v=u);try{if(l=2,a){if(c||(o="next"),e=a[o]){if(!(e=e.call(a,u)))throw TypeError("iterator result is not an object");if(!e.done)return e;u=e.value,c<2&&(c=0)}else 1===c&&(e=a.return)&&e.call(a),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=t}else if((e=(f=h.n<0)?u:r.call(n,h))!==i)break}catch(e){a=t,c=1,u=e}finally{l=1}}return{value:e,done:f}}}(r,o,a),!0),l}var i={};function c(){}function u(){}function l(){}e=Object.getPrototypeOf;var s=[][n]?e(e([][n]())):(Nt(e={},n,function(){return this}),e),f=l.prototype=c.prototype=Object.create(s);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,Nt(t,o,"GeneratorFunction")),t.prototype=Object.create(f),t}return u.prototype=l,Nt(f,"constructor",l),Nt(l,"constructor",u),u.displayName="GeneratorFunction",Nt(l,o,"GeneratorFunction"),Nt(f),Nt(f,o,"Generator"),Nt(f,n,function(){return this}),Nt(f,"toString",function(){return"[object Generator]"}),(Dt=function(){return{w:a,m:h}})()}function Nt(t,e,r,n){var o=Object.defineProperty;try{o({},"",{})}catch(t){o=0}Nt=function(t,e,r,n){function a(e,r){Nt(t,e,function(t){return this._invoke(e,r,t)})}e?o?o(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n}):t[e]=r:(a("next",0),a("throw",1),a("return",2))},Nt(t,e,r,n)}function Ht(t,e,r,n,o,a,i){try{var c=t[a](i),u=c.value}catch(t){return void r(t)}c.done?e(u):Promise.resolve(u).then(n,o)}function Ut(t){return function(){var e=this,r=arguments;return new Promise(function(n,o){var a=t.apply(e,r);function i(t){Ht(a,n,o,i,c,"next",t)}function c(t){Ht(a,n,o,i,c,"throw",t)}i(void 0)})}}function Wt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ft(n.key),n)}}function Ft(t){var e=function(t){if("object"!=Bt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=Bt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Bt(e)?e:e+""}var qt="player",$t="computer",Jt="attack",Vt="move",Kt={Swordsman:{move:4,attack:1},Undead:{move:4,attack:1},Bowman:{move:2,attack:2},Vampire:{move:2,attack:2},Magician:{move:1,attack:4},Daemon:{move:1,attack:4}},Qt=function(){return t=function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.gamePlay=e,this.stateService=r,this.playerTypes=[L,rt,$],this.opponentTypes=[X,H,R],this.characterManager=new Lt,this.positionCalculator=new wt(e.boardSize,this.characterManager),this.aiController=new zt(this.characterManager,this.positionCalculator,this.playerTypes,this.opponentTypes),this.selectedCharacterIndex=null,this.activeSelectCell=-1,this.currentTurn=qt,this.currentTheme=l.prairie,this.gameOver=!1,this.maxScore=0},e=[{key:"init",value:function(){this.setupEventListeners(),this.startNewGame()}},{key:"reset",value:function(){this.characterManager=new Lt,this.positionCalculator=new wt(this.gamePlay.boardSize,this.characterManager),this.aiController=new zt(this.characterManager,this.positionCalculator,this.playerTypes,this.opponentTypes),this.selectedCharacterIndex=null,this.activeSelectCell=-1,this.currentTurn=qt,this.currentTheme=l.prairie,this.gameOver=!1,this.maxScore=0}},{key:"setupEventListeners",value:function(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGameState.bind(this)),this.gamePlay.addLoadGameListener(this.loadGameState.bind(this))}},{key:"onCellClick",value:(y=Ut(Dt().m(function t(e){var r,n;return Dt().w(function(t){for(;;)switch(t.n){case 0:if(!this.gameOver&&this.currentTurn===qt){t.n=1;break}return t.a(2);case 1:if(r=this.characterManager.getCharacterAt(e),null===this.selectedCharacterIndex){t.n=3;break}return t.n=2,this.handleActionWithSelectedCharacter(e);case 2:t.n=4;break;case 3:this.handleCharacterSelection(e,r),n=this.getMoveRange(r),this.gamePlay.highlightRange(e,n);case 4:return t.a(2)}},t,this)})),function(t){return y.apply(this,arguments)})},{key:"handleActionWithSelectedCharacter",value:(c=Ut(Dt().m(function t(e){var r,n,o,a,i;return Dt().w(function(t){for(;;)switch(t.n){case 0:if(r=this.characterManager.getCharacterAt(this.selectedCharacterIndex)){t.n=1;break}return this.deselectAllCells(),t.a(2);case 1:if(!(n=this.characterManager.getCharacterAt(e))||!this.isPlayerCharacter(n)){t.n=2;break}return this.selectCharacter(e),o=this.getMoveRange(n),this.gamePlay.highlightRange(e,o),t.a(2);case 2:if(n||!this.canMoveTo(r,this.selectedCharacterIndex,e)){t.n=5;break}return t.n=3,this.moveCharacter(this.selectedCharacterIndex,e);case 3:return a=this.characterManager.getCharacterAt(e),i=this.getMoveRange(a),this.gamePlay.highlightRange(e,i),t.n=4,this.endPlayerTurn();case 4:return t.a(2);case 5:if(!n||this.isPlayerCharacter(n)||!this.canAttack(r,this.selectedCharacterIndex,e)){t.n=8;break}return t.n=6,this.attackCharacter(this.selectedCharacterIndex,e);case 6:return t.n=7,this.endPlayerTurn();case 7:return t.a(2);case 8:u.showError("Недопустимое действие"),this.gamePlay.setCursor(h);case 9:return t.a(2)}},t,this)})),function(t){return c.apply(this,arguments)})},{key:"handleCharacterSelection",value:function(t,e){e&&this.isPlayerCharacter(e)&&this.selectCharacter(t)}},{key:"selectCharacter",value:function(t){null!==this.selectedCharacterIndex&&-1!==this.selectedCharacterIndex&&this.gamePlay.deselectCell(this.selectedCharacterIndex),this.selectedCharacterIndex=t,null!==t&&-1!==t&&this.gamePlay.selectCell(t)}},{key:"onCellEnter",value:function(t){if(!this.gameOver&&this.currentTurn===qt){var e=this.characterManager.getCharacterAt(t);e&&this.gamePlay.showCellTooltip(this.formatCharacterInfo(e),t),null===this.selectedCharacterIndex?this.handleHoverWithoutSelection(e):this.handleHoverWithSelection(t,e)}}},{key:"handleHoverWithoutSelection",value:function(t){this.gamePlay.setCursor(t&&this.isPlayerCharacter(t)?s:h)}},{key:"handleHoverWithSelection",value:function(t,e){var r=this.characterManager.getCharacterAt(this.selectedCharacterIndex),n=this.positionCalculator.calculateDistance(this.selectedCharacterIndex,t);e&&this.isPlayerCharacter(e)?this.gamePlay.setCursor(s):e&&!this.isPlayerCharacter(e)?this.handleEnemyHover(t,r,n):this.handleEmptyCellHover(t,r,n),this.updateActiveSelection(t)}},{key:"handleEnemyHover",value:function(t,e,r){r<=this.getAttackRange(e)?(this.gamePlay.setCursor(f),this.gamePlay.selectCell(t,"red")):this.gamePlay.setCursor(h)}},{key:"handleEmptyCellHover",value:function(t,e,r){r<=this.getMoveRange(e)?(this.gamePlay.setCursor(s),this.gamePlay.selectCell(t,"green")):this.gamePlay.setCursor(h)}},{key:"updateActiveSelection",value:function(t){-1!==this.activeSelectCell&&null!==this.activeSelectCell&&this.gamePlay.deselectCell(this.activeSelectCell),this.activeSelectCell=t}},{key:"onCellLeave",value:function(t){this.gamePlay.hideCellTooltip(t)}},{key:"canMoveTo",value:function(t,e,r){return this.positionCalculator.calculateDistance(e,r)<=this.getMoveRange(t)&&!this.characterManager.isPositionOccupied(r)}},{key:"canAttack",value:function(t,e,r){return this.positionCalculator.calculateDistance(e,r)<=this.getAttackRange(t)}},{key:"getMoveRange",value:function(t){var e,r;return null!==(e=null===(r=Kt[t.constructor.name])||void 0===r?void 0:r.move)&&void 0!==e?e:1}},{key:"getAttackRange",value:function(t){var e,r;return null!==(e=null===(r=Kt[t.constructor.name])||void 0===r?void 0:r.attack)&&void 0!==e?e:1}},{key:"isPlayerCharacter",value:function(t){return this.playerTypes.some(function(e){return t instanceof e})}},{key:"performComputerTurn",value:(i=Ut(Dt().m(function t(){var e,r,n,o=this;return Dt().w(function(t){for(;;)switch(t.n){case 0:if(e=this.characterManager.getCharactersByTeam(this.playerTypes,this.opponentTypes),0!==(r=e.computer).length){t.n=1;break}return this.switchTurn(),t.a(2);case 1:if(!(n=this.aiController.findBestAction(r))){t.n=2;break}return t.n=2,this.executeAction(n);case 2:if(this.characterManager.positionedCharacters.some(function(t){return o.isPlayerCharacter(t.character)})){t.n=3;break}return this.endGame(!1),t.a(2);case 3:this.switchTurn();case 4:return t.a(2)}},t,this)})),function(){return i.apply(this,arguments)})},{key:"executeAction",value:(a=Ut(Dt().m(function t(e){return Dt().w(function(t){for(;;)switch(t.n){case 0:if(e.type!==Jt){t.n=2;break}return t.n=1,this.attackCharacter(e.fromIndex,e.toIndex);case 1:t.n=3;break;case 2:if(e.type!==Vt){t.n=3;break}return t.n=3,this.moveCharacter(e.fromIndex,e.toIndex);case 3:return t.a(2)}},t,this)})),function(t){return a.apply(this,arguments)})},{key:"attackCharacter",value:(o=Ut(Dt().m(function t(e,r){var n,o,a;return Dt().w(function(t){for(;;)switch(t.n){case 0:if(n=this.characterManager.getCharacterAt(e),o=this.characterManager.getCharacterAt(r),n&&o){t.n=1;break}return u.showError("Атакующий или цель не найдены"),this.deselectAllCells(),t.a(2);case 1:return a=Math.max(n.attack-o.defence,.1*n.attack),o.health=Math.max(o.health-a,0),t.n=2,this.gamePlay.showDamage(r,Math.round(a));case 2:0===o.health&&(this.characterManager.removeCharacter(r),this.checkForLevelUpOrNextLevel(),this.selectedCharacterIndex===r&&(this.selectedCharacterIndex=null)),this.gamePlay.redrawPositions(this.characterManager.positionedCharacters);case 3:return t.a(2)}},t,this)})),function(t,e){return o.apply(this,arguments)})},{key:"moveCharacter",value:(n=Ut(Dt().m(function t(e,r){return Dt().w(function(t){for(;;)switch(t.n){case 0:if(this.characterManager.moveCharacter(e,r)){t.n=1;break}return u.showError("Персонаж не найден для перемещения"),this.deselectAllCells(),t.a(2);case 1:this.gamePlay.redrawPositions(this.characterManager.positionedCharacters);case 2:return t.a(2)}},t,this)})),function(t,e){return n.apply(this,arguments)})},{key:"endPlayerTurn",value:(r=Ut(Dt().m(function t(){return Dt().w(function(t){for(;;)switch(t.n){case 0:return this.deselectAllCells(),this.switchTurn(),this.gamePlay.clearHighlights(),t.n=1,this.delay(200);case 1:if(this.currentTurn!==$t){t.n=2;break}return t.n=2,this.performComputerTurn();case 2:return t.a(2)}},t,this)})),function(){return r.apply(this,arguments)})},{key:"deselectAllCells",value:function(){null!==this.selectedCharacterIndex&&-1!==this.selectedCharacterIndex&&this.gamePlay.deselectCell(this.selectedCharacterIndex),null!==this.activeSelectCell&&-1!==this.activeSelectCell&&this.gamePlay.deselectCell(this.activeSelectCell),this.selectedCharacterIndex=null,this.activeSelectCell=-1}},{key:"switchTurn",value:function(){this.currentTurn=this.currentTurn===qt?$t:qt}},{key:"delay",value:function(t){return new Promise(function(e){return setTimeout(e,t)})}},{key:"saveGameState",value:function(){var t=this.characterManager.positionedCharacters.map(function(t){var e=t.character;return{position:t.position,character:{type:e.constructor.name,level:e.level,attack:e.attack,defence:e.defence,health:e.health}}}),e=new dt({currentTheme:this.currentTheme,currentTurn:this.currentTurn,characterPositions:t,selectedCharacterIndex:this.selectedCharacterIndex,activeSelectCell:this.activeSelectCell,gameOver:this.gameOver,maxScore:this.maxScore});this.stateService.save(e)}},{key:"loadGameState",value:function(){var t=this,e=this.stateService.load();e?(this.reset(),this.currentTheme=e.currentTheme,this.currentTurn=e.currentTurn,this.gameOver=e.gameOver,this.maxScore=e.maxScore,e.characterPositions.forEach(function(e){var r,n=e.character,o=e.position;switch(n.type){case"Bowman":r=new L(n.level);break;case"Vampire":r=new R(n.level);break;case"Undead":r=new H(n.level);break;case"Magician":r=new $(n.level);break;case"Daemon":r=new X(n.level);break;case"Swordsman":r=new rt(n.level);break;default:return void console.warn("Неизвестный тип персонажа: ".concat(n.type))}Object.assign(r,{attack:n.attack,defence:n.defence,health:n.health}),t.characterManager.addCharacter(r,o)}),this.selectedCharacterIndex=e.selectedCharacterIndex,this.activeSelectCell=e.activeSelectCell,this.gamePlay.drawUi(this.currentTheme),this.gamePlay.redrawPositions(this.characterManager.positionedCharacters),this.currentTurn!==$t||this.gameOver||this.performComputerTurn()):u.showError("Нет сохраненного состояния")}},{key:"formatCharacterInfo",value:function(t){return"🎖".concat(t.level," ⚔").concat(t.attack," 🛡").concat(t.defence," ❤").concat(t.health).trim()}},{key:"createTeams",value:function(t,e){if(t){var r=this.positionCalculator.getBorderColumnsIndices("first"),n=ht(this.playerTypes,1,4).characters;this.characterManager.assignTeamToPositions(n,r)}if(e){var o=this.positionCalculator.getBorderColumnsIndices("last"),a=ht(this.opponentTypes,1,4).characters;this.characterManager.assignTeamToPositions(a,o)}this.gamePlay.redrawPositions(this.characterManager.positionedCharacters)}},{key:"checkForLevelUpOrNextLevel",value:function(){var t=this;0===this.characterManager.getCharactersByTeam(this.playerTypes,this.opponentTypes).computer.length&&(this.currentTheme!==l.mountain&&this.characterManager.positionedCharacters.forEach(function(e){t.isPlayerCharacter(e.character)&&t.levelUpCharacter(e.character)}),this.nextLevel())}},{key:"levelUpCharacter",value:function(t){t.level+=1;var e=t.attack,r=t.defence;t.attack=Math.max(e,e*(80+t.health)/100),t.defence=Math.max(r,r*(80+t.health)/100),t.health=Math.min(t.health+80,100)}},{key:"nextLevel",value:function(){var t=this,e=Object.keys(l),r=e.indexOf(this.currentTheme);if(-1===r||r>=e.length-1)this.endGame(!0);else{var n=r+1,o=this.characterManager.positionedCharacters.filter(function(e){return t.isPlayerCharacter(e.character)}).map(function(t){return t.character});this.reset(),this.currentTheme=e[n],this.gamePlay.drawUi(l[this.currentTheme]);var a=this.positionCalculator.getBorderColumnsIndices("first");this.characterManager.assignTeamToPositions(o,a),this.createTeams(!1,!0),this.performComputerTurn()}}},{key:"endGame",value:function(t){var e=this;this.gameOver=!0;var r=this.characterManager.positionedCharacters.filter(function(t){return e.isPlayerCharacter(t.character)}).map(function(t){return t.character}).reduce(function(t,e){return t+e.level},0);this.maxScore=r,t?u.showMessage("Вы победили!"):u.showMessage("Вы проиграли.")}},{key:"startNewGame",value:function(){this.reset(),this.gamePlay.drawUi(this.currentTheme),this.createTeams(!0,!0),this.currentTurn!==$t||this.gameOver||this.performComputerTurn()}}],e&&Wt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,r,n,o,a,i,c,y}();function Xt(t){return Xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Xt(t)}function Yt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Zt(n.key),n)}}function Zt(t){var e=function(t){if("object"!=Xt(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var r=e.call(t,"string");if("object"!=Xt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Xt(e)?e:e+""}var te=function(){return t=function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.storage=e},(e=[{key:"save",value:function(t){this.storage.setItem("state",JSON.stringify(t))}},{key:"load",value:function(){try{var t=JSON.parse(this.storage.getItem("state"));return t?dt.from(t):null}catch(t){return null}}}])&&Yt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}(),ee=new u;ee.bindToDOM(document.querySelector("#game-container")),new Qt(ee,new te(localStorage)).init()})();